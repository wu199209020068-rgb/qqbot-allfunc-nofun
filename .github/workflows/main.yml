name: 我的QQ机器人(纯商用无娱乐)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
      - name: 拉取仓库文件
        uses: actions/checkout@v3

      - name: 安装Python环境
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: 安装Python依赖库 (原版不变)
        run: |
          python -m pip install --upgrade pip
          pip install nonebot2 nonebot-adapter-onebot==2.2.0 websockets requests httpx python-dotenv pycryptodome

      - name: 下载最新版go-cqhttp (修复404/内存报错，只改这1行，原版是固定版本，现在自动拉最新稳定版)
        run: |
          wget -O go-cqhttp.tar.gz https://github.com/Mrs4s/go-cqhttp/releases/latest/download/go-cqhttp_linux_amd64.tar.gz
          tar -zxvf go-cqhttp.tar.gz
          chmod +x go-cqhttp

      - name: 创建go-cqhttp配置文件 (原版不变，修复扫码失效)
        run: |
          echo '{"uin":0,"password":"","protocol":1,"platform":"linux","heartbeat_interval":5,"enable_db":true,"db_path":"./data/db","access_token":"","secret":"","post_url":"","post_message_format":"string","ignore_invalid_cqcode":false,"force_fragment":false,"proxy_rewrite":"","reconnect_interval":3,"use_sso_address":true,"enable_msg_cache":true,"msg_cache_time":120,"enable_sync_database":true}' > config.json

      - name: 启动QQ机器人 (修复启动超时，只加sleep 20，原版是sleep10，其余不变)
        run: |
          nohup ./go-cqhttp faststart > ./cq.log 2>&1 &
          sleep 20
          python -m nonebot run --host=0.0.0.0 --port=8080
