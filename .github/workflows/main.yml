name: 我的QQ机器人(纯商用无娱乐)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 拉取仓库文件
        uses: actions/checkout@v3

      - name: 安装Python环境
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: 安装Python依赖库
        run: |
          python -m pip install --upgrade pip
          pip install nonebot2 nonebot-adapter-onebot websockets requests

      - name: 下载最新go-cqhttp(修复404)
        run: |
          wget -O go-cqhttp.tar.gz https://github.com/Mrs4s/go-cqhttp/releases/download/v1.2.4/go-cqhttp_linux_amd64.tar.gz
          tar -zxvf go-cqhttp.tar.gz
          chmod +x go-cqhttp

      - name: 创建go-cqhttp配置文件
        run: |
          echo '{"uin":0,"password":"","protocol":2,"platform":"linux","heartbeat_interval":5,"enable_db":true,"db_path":"./data/db","access_token":"","secret":"","post_url":"","post_message_format":"string","ignore_invalid_cqcode":false,"force_fragment":false,"proxy_rewrite":"","reconnect_interval":3,"use_sso_address":false,"enable_msg_cache":true,"msg_cache_time":120,"enable_sync_database":true}' > config.json

      - name: 启动QQ机器人
        run: |
          nohup ./go-cqhttp faststart &
          sleep 10
          python main.py
